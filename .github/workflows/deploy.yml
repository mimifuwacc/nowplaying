name: Deploy

on:
  pull_request_target:
    types: [closed]
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  deploy:
    name: Deploy
    permissions:
      contents: write

    if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'changeset-release/')

    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Get changed packages
        id: changed-packages
        run: |
          # changeset-release ブランチと origin/main の差分で変更された package.json を検出
          git fetch origin main

          # API の変更をチェック
          if git diff --name-only origin/main...HEAD | grep -q "apps/api/package.json"; then
            API_VERSION=$(node -p "require('./apps/api/package.json').version")
            echo "api=true" >> $GITHUB_OUTPUT
            echo "api_version=$API_VERSION" >> $GITHUB_OUTPUT
            echo "API package changed: $API_VERSION"
          else
            echo "api=false" >> $GITHUB_OUTPUT
            echo "API package not changed"
          fi

          # Extension の変更をチェック
          if git diff --name-only origin/main...HEAD | grep -q "apps/extension/package.json"; then
            EXT_VERSION=$(node -p "require('./apps/extension/package.json').version")
            echo "extension=true" >> $GITHUB_OUTPUT
            echo "extension_version=$EXT_VERSION" >> $GITHUB_OUTPUT
            echo "Extension package changed: $EXT_VERSION"
          else
            echo "extension=false" >> $GITHUB_OUTPUT
            echo "Extension package not changed"
          fi

      - name: Create and push API tag
        if: steps.changed-packages.outputs.api == 'true'
        run: |
          API_VERSION="${{ steps.changed-packages.outputs.api_version }}"

          if ! git rev-parse "api@$API_VERSION" >/dev/null 2>&1; then
            git tag "api@$API_VERSION"
            git push origin "api@$API_VERSION"
            echo "Created tag: api@$API_VERSION"
          else
            echo "Tag api@$API_VERSION already exists"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push Extension tag
        if: steps.changed-packages.outputs.extension == 'true'
        run: |
          EXT_VERSION="${{ steps.changed-packages.outputs.extension_version }}"

          if ! git rev-parse "extension@$EXT_VERSION" >/dev/null 2>&1; then
            git tag "extension@$EXT_VERSION"
            git push origin "extension@$EXT_VERSION"
            echo "Created tag: extension@$EXT_VERSION"
          else
            echo "Tag extension@$EXT_VERSION already exists"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
